window.onload = function() {
  // Se os parâmetros vierem na hash, converte para query string e recarrega
  if (window.location.hash && window.location.hash.startsWith('#')) {
    const hashParams = window.location.hash.substring(1); // remove o '#'
    const newUrl = window.location.origin + window.location.pathname + '?' + hashParams;
    window.location.replace(newUrl);
    return;
  }

  // Extrai parâmetros da query string
  const params = new URLSearchParams(window.location.search);
  const token = params.get('access_token') || params.get('token') || params.get('token_hash') || params.get('code');
  const type = params.get('type');

  function isMobile() {
    return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);
  }

  if (token && (type === 'recovery' || !type)) {
    const deepLink = `fitjourney://reset-password?access_token=${token}${type ? `&type=${type}` : ''}`;
    document.getElementById('manual-btn').onclick = function() {
      window.location.href = deepLink;
    }
    if (isMobile()) {
      setTimeout(() => {
        window.location.href = deepLink;
      }, 1200);
    } else {
      document.getElementById('spinner').style.display = 'none';
      document.getElementById('info').style.display = 'block';
    }
  } else {
    document.getElementById('msg').innerHTML = "<b>Token inválido ou ausente.</b><br>Por favor, solicite um novo link de recuperação.";
    document.getElementById('spinner').style.display = 'none';
    document.getElementById('manual-btn').style.display = 'none';
  }
}
